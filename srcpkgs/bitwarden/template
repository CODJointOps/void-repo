pkgname=bitwarden
version=2026.1.0
revision=2
archs="x86_64* aarch64*"
short_desc="Bitwarden desktop password manager"
maintainer="rich@bandaholics.cash"
license="GPL-3.0-or-later"
homepage="https://bitwarden.com"

case "${XBPS_TARGET_MACHINE}" in
	x86_64*)
		_upstream_arch=amd64
		_archive=Bitwarden-${version}-${_upstream_arch}.deb
		checksum=6db36b2ed691901483a1c2355bdef5ca102a1f53a26cf4be2173b9e1a4b252e5
		;;
	aarch64*)
		_upstream_arch=arm64
		_archive=bitwarden_${version}_${_upstream_arch}.tar.gz
		checksum=fbc37d49a40a7302731476d98730557ad7e54f1bd1bcfca85b77e3ae1de2febf
		;;
esac
distfiles="https://github.com/bitwarden/clients/releases/download/desktop-v${version}/${_archive}"

hostmakedepends="tar xz"
depends="gtk+3 nss alsa-lib libnotify libXScrnSaver dbus-glib"

do_extract() {
    case "${_archive}" in
        *.deb)
            ar x ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${_archive}
            tar xf data.tar.xz -C ${wrksrc}
            ;;
        *.tar.gz)
            tar xf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${_archive}
            local _appdir
            _appdir="$(find . -maxdepth 1 -type d -name 'Bitwarden-linux-*' -print -quit)"
            [ -n "${_appdir}" ] || msg_error "Unable to find extracted Bitwarden directory\n"
            mkdir -p ${wrksrc}/opt/Bitwarden
            cp -a ${_appdir}/. ${wrksrc}/opt/Bitwarden/
            ;;
    esac
}

do_install() {
    vmkdir /usr/bin

    if [ -d usr/share/icons/hicolor ]; then
        vmkdir /usr/share/icons/hicolor
        vcopy usr/share/icons/hicolor/* /usr/share/icons/hicolor/
    fi

    if [ -d usr/share/applications ]; then
        vmkdir /usr/share/applications
        vcopy usr/share/applications/* /usr/share/applications/
    fi

    if [ -d usr/share/doc/bitwarden ]; then
        vmkdir /usr/share/doc/bitwarden
        vcopy usr/share/doc/bitwarden/* /usr/share/doc/bitwarden/
    fi

    mkdir -p ${PKGDESTDIR}/opt/Bitwarden
    cp -a ${wrksrc}/opt/Bitwarden/* ${PKGDESTDIR}/opt/Bitwarden/

    ln -sf /opt/Bitwarden/bitwarden ${PKGDESTDIR}/usr/bin/bitwarden

    if [ -f ${PKGDESTDIR}/opt/Bitwarden/chrome-sandbox ]; then
        chmod 4755 ${PKGDESTDIR}/opt/Bitwarden/chrome-sandbox
    fi

    if [ -f opt/Bitwarden/LICENSE.electron.txt ]; then
        vlicense opt/Bitwarden/LICENSE.electron.txt
    fi

    if [ -f opt/Bitwarden/LICENSES.chromium.html ]; then
        vlicense opt/Bitwarden/LICENSES.chromium.html
    fi
}
